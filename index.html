<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPORT LIVE</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content: blob:;">

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="estilos.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
</head>
<body>

    <div id="login-screen"> 
        <div class="login-card">
            <h1>SPORT ID</h1>
            <p>ACCESO PRIVADO</p>
            <form id="login-form">
                <input type="password" id="input-password" class="login-input" placeholder="CONTRASEÃ‘A" required>
                <button type="submit" id="btn-login" class="btn-primary">ENTRAR</button>
            </form>
            <p id="login-error" style="color:red; display:none; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-content" style="display:none;"> 
        <header>
            <div class="logo">MY<span style="color:#fff">SPORT</span></div>
            <div class="user-menu">
                <button onclick="location.reload()" class="btn-logout">SALIR</button>
            </div>
        </header>

        <main>
            <section id="lista-partidos">
                <h2 class="section-title">EN DIRECTO</h2>
                <div id="partidos-container">
                    <p style="color:white; text-align:center">Conectando con satÃ©lite...</p>
                </div>
            </section>

            <section id="reproductor-seccion" style="display:none; margin-top:20px;">
                <div class="reproductor-header">
                    <h2 id="titulo-partido" style="text-transform:uppercase;">PARTIDO</h2>
                    <button onclick="cerrarVideo()" class="btn-close">CERRAR</button>
                </div>
                <div id="player-wrapper" style="width: 100%; height: 500px; background:black;"></div>
            </section>
        </main>
    </div>

    <script>
        // --- CONFIGURACIÃ“N ---
        const PASSWORD = "futbol"; 
        const URL_GITHUB = 'https://raw.githubusercontent.com/M4RCUS21/futbol-tv/main/lista.m3u';
        var playerInstance = null;

        // LOGIN
        document.getElementById('login-form').addEventListener('submit', function(e){
            e.preventDefault();
            if(document.getElementById('input-password').value === PASSWORD){
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                buscarEnlace();
            } else {
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('login-error').innerText = "ContraseÃ±a incorrecta";
            }
        });

        // BUSCAR ENLACE
        function buscarEnlace(){
            fetch(URL_GITHUB).then(res => res.text()).then(texto => {
                const lineas = texto.split('\n');
                let url = "";
                for(let l of lineas) if(l.trim().startsWith('http')) { url = l.trim(); break; }
                
                const container = document.getElementById('partidos-container');
                container.innerHTML = "";

                if(url) {
                    crearBoton(url);
                } else {
                    container.innerHTML = "<h3>NO HAY SEÃ‘AL</h3>";
                }
            });
        }

        // CREAR BOTÃ“N
        function crearBoton(url){
            const btn = document.createElement('div');
            btn.className = 'partido-item';
            btn.style = "background:#222; padding:20px; border-radius:10px; cursor:pointer; border:1px solid #444; text-align:center;";
            btn.innerHTML = "<h2 style='color:white; margin:0'>ðŸ“º VER CANAL EN DIRECTO</h2>";
            
            btn.onclick = function(){
                document.getElementById('reproductor-seccion').style.display = 'block';
                iniciarClappr(url);
            };
            document.getElementById('partidos-container').appendChild(btn);
        }

        // INICIAR CLAPPR (LA MAGIA)
        function iniciarClappr(urlOriginal){
            // Limpiar anterior
            if(playerInstance) { playerInstance.destroy(); }
            document.getElementById('player-wrapper').innerHTML = "";

            // Intento 1: Directo (si el servidor es bueno)
            // Intento 2: Con Proxy (si bloquean CORS)
            
            // Usamos un proxy diferente: "allorigins" a veces va mejor para m3u8
            // Pero primero probamos el truco de Clappr:
            
            playerInstance = new Clappr.Player({
                source: urlOriginal, 
                parentId: "#player-wrapper",
                width: '100%',
                height: '100%',
                autoPlay: true,
                hlsjsConfig: {
                    xhrSetup: function(xhr, url) {
                        // Esto intenta engaÃ±ar al servidor diciendo que somos una web normal
                        xhr.withCredentials = false; 
                    }
                }
            });
        }

        function cerrarVideo(){
            if(playerInstance) { playerInstance.stop(); }
            document.getElementById('reproductor-seccion').style.display = 'none';
        }
    </script>
</body>
</html>
